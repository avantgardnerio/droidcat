# Import all classification package
from sklearn.ensemble import RandomForestClassifier, ExtraTreesClassifier, AdaBoostClassifier, BaggingClassifier, GradientBoostingClassifier, VotingClassifier
from sklearn.tree import DecisionTreeClassifier
from sklearn.svm import SVC
from sklearn.naive_bayes import GaussianNB, MultinomialNB, BernoulliNB
from sklearn.neighbors import KNeighborsClassifier

from sklearn.cross_validation import cross_val_score
from sklearn.metrics import precision_score,recall_score,f1_score,roc_auc_score,accuracy_score

from sklearn.metrics import confusion_matrix

#from sklearn.mixture import GaussianMixture
#from sklearn.mixture import BayesianGaussianMixture
from sklearn.gaussian_process import GaussianProcessClassifier
from sklearn.gaussian_process.kernels import RBF

import numpy
import random
import os
import sys
import string

import inspect, re

from configs import *
from featureLoader import *

g_binary = False # binary or multiple-class classification

def varname(p):
    for line in inspect.getframeinfo(inspect.currentframe().f_back)[3]:
        m = re.search(r'\bvarname\s*\(\s*([A-Za-z_][A-Za-z0-9_]*)\s*\)', line)
        if m:
            return m.group(1)

def dumpMalwareFeaturesWithFamily(mf, ml, year):
    mfh = file ('malware-withFamily-%d.txt' % (year), 'w')
    for key in mf.keys():
        print >> mfh, "%s,%s,%s" % (key, ml[key], mf[key])

    mfh.close()

if __name__=="__main__":
    bPrune = False
    datasets = [ {"benign":["zoobenign2010"], "malware":["zoo2010"]},
                  {"benign":["zoobenign2011"], "malware":["zoo2011"]},
                  {"benign":["zoobenign2012"], "malware":["zoo2012", "malware2013"]},
                  {"benign":["zoobenign2013"], "malware":["zoo2013", "vs2013", "malware-drebin"]},
                  {"benign":["zoobenign2014", "benign2014"], "malware":["zoo2014", "vs2014"]},
                  {"benign":["zoobenign2015"], "malware":["zoo2015", "vs2015"]},
                  {"benign":["zoobenign2016"], "malware":["zoo2016", "vs2016"]},
                  {"benign":["benign2017"], "malware":["zoo2017", "malware2017"]} ]

    (mf0, ml0) = loadMalwareData(g_binary, 'features_droidcat/zoo2010','/home/hcai/Downloads/AndroZoo/2010', pruneMinor=bPrune, drebin=False, obf=True)
    dumpMalwareFeaturesWithFamily(mf0, ml0, 2010)

    (mf1, ml1) = loadMalwareData(g_binary, 'features_droidcat/zoo2011','/home/hcai/Downloads/AndroZoo/2011', pruneMinor=bPrune, drebin=False, obf=True)
    dumpMalwareFeaturesWithFamily(mf1, ml1, 2011)

    (mf2, ml2) = loadMalwareData(g_binary, 'features_droidcat/zoo2012','/home/hcai/Downloads/AndroZoo/2012', pruneMinor=bPrune, drebin=False, obf=True)
    (mf21,ml21) = loadMalwareData(g_binary, 'features_droidcat/malware2013','/home/hcai/testbed/inputs/uniqMalware', pruneMinor=bPrune, drebin=False, obf=False, malgenome=True)
    mf2.update(mf21)
    ml2.update(ml21)
    dumpMalwareFeaturesWithFamily(mf2, ml2, 2012)


    (mf3, ml3) = loadMalwareData(g_binary, 'features_droidcat/zoo2013','/home/hcai/Downloads/AndroZoo/2013', pruneMinor=bPrune, drebin=False, obf=True)
    (mf31, ml31) = loadMalwareData(g_binary, 'features_droidcat/vs2013','/home/hcai/Downloads/VirusShare/2013/', pruneMinor=bPrune, drebin=False, obf=True)
    (mf32, ml32) = loadMalwareData(g_binary, 'features_droidcat/malware-drebin','/home/hcai/Downloads/Drebin', pruneMinor=bPrune, drebin=True, obf=False)
    mf3.update (mf31)
    ml3.update (ml31)
    mf3.update (mf32)
    ml3.update (ml32)
    dumpMalwareFeaturesWithFamily(mf3, ml3, 2013)

    (mf4, ml4) = loadMalwareData(g_binary, 'features_droidcat/zoo2014','/home/hcai/Downloads/AndroZoo/2014', pruneMinor=bPrune, drebin=False, obf=False)
    (mf41, ml41) = loadMalwareData(g_binary, 'features_droidcat/vs2014','/home/hcai/Downloads/VirusShare/2014/', pruneMinor=bPrune, drebin=False, obf=True)
    mf4.update (mf41)
    ml4.update (ml41)
    dumpMalwareFeaturesWithFamily(mf4, ml4, 2014)

    (mf5, ml5) = loadMalwareData(g_binary, 'features_droidcat/zoo2015','/home/hcai/Downloads/AndroZoo/2015', pruneMinor=bPrune, drebin=False, obf=False)
    (mf51, ml51) = loadMalwareData(g_binary, 'features_droidcat/vs2015','/home/hcai/Downloads/VirusShare/2015/', pruneMinor=bPrune, drebin=False, obf=True)
    mf5.update (mf51)
    ml5.update (ml51)
    dumpMalwareFeaturesWithFamily(mf5, ml5, 2015)

    (mf6, ml6) = loadMalwareData(g_binary, 'features_droidcat/zoo2016','/home/hcai/Downloads/AndroZoo/2016', pruneMinor=bPrune, drebin=False, obf=False)
    (mf61, ml61) = loadMalwareData(g_binary, 'features_droidcat/vs2016','/home/hcai/Downloads/VirusShare/2016/', pruneMinor=bPrune, drebin=False, obf=True)
    mf6.update (mf61)
    ml6.update (ml61)
    dumpMalwareFeaturesWithFamily(mf6, ml6, 2016)

    (mf7, ml7) = loadMalwareData(g_binary, 'features_droidcat/malware2017','/home/hcai/testbed/newmalwareall', pruneMinor=bPrune, drebin=False, obf=False)
    (mf71, ml71) = loadMalwareData(g_binary, 'features_droidcat/zoo2017','/home/hcai/Downloads/AndroZoo/2017', pruneMinor=bPrune, drebin=False, obf=True)
    mf7.update(mf71)
    ml7.update(ml71)
    dumpMalwareFeaturesWithFamily(mf7, ml7, 2017)

    sys.exit(0)

# hcai: set ts=4 tw=120 sts=4 sw=4
